{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container">
    <h2 class="page-title">Dashboard</h2>
    <p class="page-subtitle">Overview of operations and quick actions.</p>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>Quick Actions</h3>
            <div class="quick-actions">
                <a href="{{ url_for('purchase_orders') }}" class="btn btn-primary">Generate PO</a>
                <a href="{{ url_for('inventory') }}" class="btn btn-secondary">Receive Stock</a>
            </div>
        </div>

        <div class="dashboard-card">
            <h3>Reports</h3>
            <div class="report-actions">
                <a href="{{ url_for('low_stock_report') }}" class="btn btn-info">Low Stock Report</a>
                <a href="{{ url_for('stock_ledger') }}" class="btn btn-info">Stock Ledger</a>
                <a href="{{ url_for('suppliers') }}" class="btn btn-info">Supplier Ledger</a>
            </div>
        </div>

        <div class="dashboard-card full-width">
            <h3>Compare Supplier Rates</h3>
            <div class="rate-comparison">
                <div class="form-group">
                    <label for="variant-select">Select a Variant:</label>
                    <select id="variant-select" class="form-control" style="width: 100%;">
                        <option value="">Loading variants...</option>
                    </select>
                </div>
                <button id="compare-rates-btn" class="btn btn-success">Compare Rates</button>
                <div id="rate-comparison-results" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for the variant dropdown
    const variantSelect = $('#variant-select').select2({
        placeholder: "Search for a variant",
        allowClear: true
    });

    // Fetch all variants for the dropdown
    fetch('/api/all-variants')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error fetching variants:', data.error);
                return;
            }
            // Clear the loading text
            variantSelect.empty();
            // Add a default placeholder
            variantSelect.append(new Option("Select a variant", "", false, false));
            // Populate the dropdown with fetched variants
            data.forEach(variant => {
                const option = new Option(variant.name, variant.id, false, false);
                variantSelect.append(option);
            });
            // Trigger a change to update the display
            variantSelect.trigger('change');
        })
        .catch(error => console.error('Error fetching variants:', error));

    // Handle the "Compare Rates" button click
    document.getElementById('compare-rates-btn').addEventListener('click', function() {
        const variantId = variantSelect.val();
        const resultsContainer = document.getElementById('rate-comparison-results');
        
        if (!variantId) {
            resultsContainer.innerHTML = '<p class="text-danger">Please select a variant first.</p>';
            return;
        }

        resultsContainer.innerHTML = '<p>Loading rates...</p>';

        // Fetch the comparison rates from the new API endpoint
        fetch(`/api/compare-rates/${variantId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    resultsContainer.innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                    return;
                }

                if (data.length === 0) {
                    resultsContainer.innerHTML = '<p>No rates found for this variant.</p>';
                    return;
                }

                // Build and display the results table
                let tableHtml = `
                    <table class="table table-bordered mt-2">
                        <thead>
                            <tr>
                                <th>Supplier</th>
                                <th>Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                data.forEach(item => {
                    tableHtml += `
                        <tr>
                            <td>${item.supplier_name}</td>
                            <td>${item.rate}</td>
                        </tr>
                    `;
                });
                tableHtml += '</tbody></table>';
                resultsContainer.innerHTML = tableHtml;
            })
            .catch(error => {
                console.error('Error comparing rates:', error);
                resultsContainer.innerHTML = '<p class="text-danger">An error occurred while fetching rates.</p>';
            });
    });
});
</script>
{% endblock %}
