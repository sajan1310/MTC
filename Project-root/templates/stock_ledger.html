{% extends "base.html" %}
{% block title %}Stock Ledger{% endblock %}

{% block content %}
<div class="container">
    <div class="form-card" style="padding: 1.5rem;">
<div class="page-header">
    <h2>Received Stock Ledger</h2>
    <div class="filter-container" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input type="text" id="ledger-search" class="search-input" placeholder="Search by supplier, bill #...">
        <select id="ledger-supplier"><option value="">All suppliers</option></select>
        <div style="position:relative;min-width:220px">
            <input type="text" id="variant-search" class="search-input" placeholder="Search variant (type to search)" autocomplete="off">
            <div id="variant-suggestions" style="position:absolute;left:0;right:0;z-index:30;background:#fff;border:1px solid #ddd;display:none;max-height:220px;overflow:auto"></div>
        </div>
        <input type="date" id="ledger-start-date">
        <span>-</span>
        <input type="date" id="ledger-end-date">
    </div>
</div>
<div class="inventory-table-container">
            <div class="table-wrapper">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Receipt #</th>
                            <th>Date</th>
                            <th>Bill Number</th>
                            <th>Supplier</th>
                            <th>Total Amount</th>
                            <th>Tax %</th>
                            <th>Discount</th>
                            <th>Grand Total</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stock-ledger-body">
                        <!-- Ledger entries will be populated here -->
                    </tbody>
                </table>
            </div>
            <div class="ledger-footer" style="display:flex;align-items:center;gap:0.5rem;margin-top:.5rem">
                <button id="ledger-prev" class="button" disabled>Prev</button>
                <button id="ledger-next" class="button" disabled>Next</button>
                <div id="ledger-page-info" style="margin-left:8px;color:#555">&nbsp;</div>
                <div id="ledger-loading" style="margin-left:auto;color:#555;display:none">Loading‚Ä¶</div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Details Modal -->
<div id="receipt-details-modal" class="modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3>Receipt Details</h3>
            <button type="button" class="button cancel close-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="table-wrapper">
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Color</th>
                            <th>Size</th>
                            <th>Quantity</th>
                            <th>Cost per Unit</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-details-body">
                        <!-- Receipt items will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ledgerBody = document.getElementById('stock-ledger-body');
    const detailsModal = document.getElementById('receipt-details-modal');
    const detailsBody = document.getElementById('receipt-details-body');
    const searchInput = document.getElementById('ledger-search');
    const supplierSelect = document.getElementById('ledger-supplier');
    const variantSearchInput = document.getElementById('variant-search');
    const variantSuggestions = document.getElementById('variant-suggestions');
    const startDateInput = document.getElementById('ledger-start-date');
    const endDateInput = document.getElementById('ledger-end-date');
    const prevBtn = document.getElementById('ledger-prev');
    const nextBtn = document.getElementById('ledger-next');
    const pageInfo = document.getElementById('ledger-page-info');
    const loadingIndicator = document.getElementById('ledger-loading');

    let currentPage = 1;
    const perPage = 25;
    let totalItems = 0;
    let debounceTimer = null;
    let selectedVariantId = null;
    let variantMap = {}; // name => id

    // simple spinner helper
    function showSpinner(el, show) {
        if (!el) return;
        if (show) {
            el.style.opacity = '0.6';
        } else {
            el.style.opacity = '';
        }
    }

    async function loadSuppliers() {
        try {
            const r = await fetch('/api/suppliers');
            if (!r.ok) return;
            const list = await r.json();
            supplierSelect.innerHTML = '<option value="">All suppliers</option>' + (list.map(s => `<option value="${s.supplier_id}">${(s.firm_name || '').substring(0,80)}</option>`).join(''));
        } catch (err) {
            console.error('Failed to load suppliers', err);
        }
    }

    // hide suggestions on click outside
    document.addEventListener('click', (ev) => {
        if (!variantSuggestions.contains(ev.target) && ev.target !== variantSearchInput) {
            variantSuggestions.style.display = 'none';
        }
    });

    // keyboard support: Esc hides suggestions
    variantSearchInput.addEventListener('keydown', (ev) => {
        if (ev.key === 'Escape') variantSuggestions.style.display = 'none';
    });

    function buildQueryParams(page) {
        const params = new URLSearchParams();
        const q = (searchInput.value || '').trim();
        const start = startDateInput.value;
        const end = endDateInput.value;
        if (q) params.set('q', q);
        // supplier filter
        if (supplierSelect && supplierSelect.value) params.set('supplier_id', supplierSelect.value);
        // variant filter
        if (selectedVariantId) params.set('variant_id', selectedVariantId);
        if (start) params.set('start_date', start);
        if (end) params.set('end_date', end);
        if (page) params.set('page', page);
        if (perPage) params.set('per_page', perPage);
        return params.toString();
    }

    async function fetchStockLedger(page=1) {
        loadingIndicator.style.display = 'inline';
        ledgerBody.innerHTML = `<tr><td colspan="9">Loading‚Ä¶</td></tr>`;
        try {
            const qs = buildQueryParams(page);
            const resp = await fetch(`/api/stock-receipts${qs ? `?${qs}` : ''}`);
            // if backend returns 400 for invalid filters propagate
            if (resp.status === 400) {
                const err = await resp.json();
                ledgerBody.innerHTML = `<tr><td colspan="9">${err.error || 'Invalid filter'}</td></tr>`;
                loadingIndicator.style.display = 'none';
                return;
            }
            const data = await resp.json();

            // support both old array response and new paginated object
            let receipts = [];
            if (Array.isArray(data)) {
                receipts = data;
                totalItems = receipts.length;
                currentPage = 1;
            } else if (data && data.items) {
                receipts = data.items;
                totalItems = data.total || 0;
                currentPage = data.page || page;
            } else {
                receipts = [];
                totalItems = 0;
            }

            renderStockLedger(receipts);
            updatePager();
        } catch (err) {
            console.error('Error fetching ledger', err);
            ledgerBody.innerHTML = `<tr><td colspan="9">Failed to load ledger</td></tr>`;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    function renderStockLedger(receipts) {
        if (!receipts || receipts.length === 0) {
            ledgerBody.innerHTML = '<tr><td colspan="9">No receipts found.</td></tr>';
            return;
        }
        ledgerBody.innerHTML = receipts.map(r => `
            <tr data-receipt-id="${r.receipt_id}">
                <td>${escapeHtml(r.receipt_number)}</td>
                <td>${new Date(r.receipt_date).toLocaleDateString()}</td>
                <td>${escapeHtml(r.bill_number)}</td>
                <td>${escapeHtml(r.firm_name)}</td>
                <td>${r.total_amount}</td>
                <td>${r.tax_percentage}</td>
                <td>${r.discount_amount}</td>
                <td>${r.grand_total}</td>
                <td class="actions-cell">
                    <button class="button icon-btn view-details-btn" title="View Details">üîç</button>
                    <button class="button icon-btn danger delete-receipt-btn" title="Delete Receipt">üóë</button>
                </td>
            </tr>
        `).join('');
    }

    ledgerBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('view-details-btn')) {
            const receiptId = e.target.closest('tr').dataset.receiptId;
            const response = await fetch(`/api/stock-receipts/${receiptId}`);
            const items = await response.json();
            renderReceiptDetails(items);
            detailsModal.classList.add('is-open');
        } else if (e.target.classList.contains('delete-receipt-btn')) {
            const receiptId = e.target.closest('tr').dataset.receiptId;
            if (confirm('Are you sure you want to delete this receipt? This will reverse the stock entry.')) {
                const response = await fetch(`/api/stock-receipts/${receiptId}`, { method: 'DELETE' });
                if (response.ok) {
                    // refetch current page
                    fetchStockLedger(currentPage);
                } else {
                    alert('Failed to delete receipt');
                }
            }
        }
    });

    function renderReceiptDetails(items) {
        detailsBody.innerHTML = items.map(item => `
            <tr>
                <td>${escapeHtml(item.item_name)}</td>
                <td>${escapeHtml(item.color_name)}</td>
                <td>${escapeHtml(item.size_name)}</td>
                <td>${item.quantity_added}</td>
                <td>${item.cost_per_unit}</td>
            </tr>
        `).join('');
    }

    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function updatePager() {
        const totalPages = Math.max(1, Math.ceil((totalItems || 0) / perPage));
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
        pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalItems} results)`;
    }

    prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage -= 1;
            fetchStockLedger(currentPage);
        }
    });

    nextBtn.addEventListener('click', () => {
        const totalPages = Math.max(1, Math.ceil((totalItems || 0) / perPage));
        if (currentPage < totalPages) {
            currentPage += 1;
            fetchStockLedger(currentPage);
        }
    });

    // debounce search
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            currentPage = 1;
            fetchStockLedger(1);
        }, 300);
    });

    // supplier select change
    supplierSelect.addEventListener('change', () => { currentPage = 1; fetchStockLedger(1); });

    // variant search: query /api/variants/select2 and show suggestion dropdown
    let variantTimer = null;
    variantSearchInput.addEventListener('input', () => {
        clearTimeout(variantTimer);
        variantTimer = setTimeout(async () => {
            const q = (variantSearchInput.value || '').trim();
            if (!q) { variantSuggestions.style.display = 'none'; selectedVariantId = null; return; }
            try {
                variantSuggestions.innerHTML = '<div style="padding:8px;color:#666">Searching‚Ä¶</div>';
                variantSuggestions.style.display = 'block';
                const r = await fetch(`/api/variants/select2?q=${encodeURIComponent(q)}&page=1&page_size=15`);
                if (!r.ok) { variantSuggestions.style.display = 'none'; return; }
                const payload = await r.json();
                const results = payload.results || payload.items || [];
                if (!results || results.length === 0) {
                    variantSuggestions.innerHTML = '<div style="padding:8px;color:#666">No results</div>';
                    return;
                }
                variantMap = {};
                variantSuggestions.innerHTML = results.map(row => {
                    const label = (row.text || row.name || row.item_name || '').replace(/</g,'&lt;').substring(0,200);
                    variantMap[row.id] = row;
                    return `<div class="variant-sugg" data-id="${row.id}" style="padding:8px;border-bottom:1px solid #f2f2f2;cursor:pointer">${label}</div>`;
                }).join('');

                // attach click handlers
                Array.from(variantSuggestions.querySelectorAll('.variant-sugg')).forEach(el => {
                    el.addEventListener('click', (ev) => {
                        const id = ev.currentTarget.dataset.id;
                        const item = variantMap[id];
                        if (item) {
                            variantSearchInput.value = item.text || item.name || item.item_name || '';
                            selectedVariantId = parseInt(id, 10);
                            variantSuggestions.style.display = 'none';
                            currentPage = 1; fetchStockLedger(1);
                        }
                    });
                });
            } catch (err) {
                console.error('variant search failed', err);
                variantSuggestions.style.display = 'none';
            }
        }, 300);
    });

    startDateInput.addEventListener('change', () => { currentPage = 1; fetchStockLedger(1); });
    endDateInput.addEventListener('change', () => { currentPage = 1; fetchStockLedger(1); });

    // initial load
    fetchStockLedger(1);
});
</script>
{% endblock %}
