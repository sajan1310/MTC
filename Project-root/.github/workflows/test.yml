#==============================================================================
# Legacy CI Workflow (Project-root copy)
#==============================================================================
# Note: This is a legacy copy. The main CI workflows are in the root .github/
# This file is maintained for backwards compatibility.
#==============================================================================

name: CI (Legacy)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    env:
      DATABASE_URL: postgresql://postgres:testpass@127.0.0.1:5432/testdb
      REDIS_URL: redis://localhost:6379/0
      RATELIMIT_STORAGE_URL: memory://
      FLASK_ENV: testing
      SECRET_KEY: test-secret
      PYTHONIOENCODING: utf-8
      DB_USER: postgres
      DB_PASS: testpass
      DB_NAME: testdb
      DB_HOST: 127.0.0.1
      DB_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: testdb
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'Project-root/requirements.txt'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1 postgresql-client
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Project-root/requirements.txt
      
      - name: Wait for PostgreSQL
        run: |
          for i in {1..30}; do
            if psql "$DATABASE_URL" -c '\q' 2>/dev/null; then
              echo "PostgreSQL is ready!"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done
      
      - name: Create compatibility database
        run: |
          # Create 'testuser' database for test compatibility
          psql "postgresql://postgres:testpass@127.0.0.1:5432/postgres" \
            -tAc "SELECT 1 FROM pg_database WHERE datname='testuser'" | grep -q 1 || \
          psql "postgresql://postgres:testpass@127.0.0.1:5432/postgres" \
            -c "CREATE DATABASE testuser;"
          
          echo "✅ Test database 'testuser' created successfully"
      
      - name: Initialize database schemas
        run: |
          if [ -f migrations/init_schema.sql ]; then
            echo "Initializing schema for testdb..."
            psql "postgresql://postgres:testpass@127.0.0.1:5432/testdb" \
              -f migrations/init_schema.sql || echo "⚠️  Schema init for testdb failed or already exists"
            
            echo "Initializing schema for testuser database..."
            psql "postgresql://postgres:testpass@127.0.0.1:5432/testuser" \
              -f migrations/init_schema.sql || echo "⚠️  Schema init for testuser failed or already exists"
            
            echo "✅ Database schemas initialized"
          else
            echo "⚠️  init_schema.sql not found - tests may fail if database tables are required"
          fi
        continue-on-error: true

      - name: Run database migrations
        working-directory: Project-root
        run: |
          echo "::group::Applying database migrations"
          python migrations/migrations.py || echo "⚠️ Migrations completed with warnings"
          echo "::endgroup:;"
        env:
          DATABASE_URL: postgresql://postgres:testpass@127.0.0.1:5432/testdb
          DB_USER: postgres
          DB_PASS: testpass
          DB_NAME: testdb
        continue-on-error: true

      - name: Apply schema fix
        working-directory: Project-root
        run: |
          echo "::group::Applying schema fix"
          python migrations/migration_fix_schema_nov2025.py
          echo "::endgroup:;"
        env:
          DATABASE_URL: postgresql://postgres:testpass@127.0.0.1:5432/testdb
          DB_USER: postgres
          DB_PASS: testpass
          DB_NAME: testdb
        continue-on-error: true
      
      - name: Run Ruff linter
        run: |
          ruff check Project-root/ --output-format=github
        continue-on-error: true
      
      - name: Run tests with coverage
        working-directory: Project-root
        run: |
          python -m pytest \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            -v

      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-legacy-py3.11
          if-no-files-found: warn
          retention-days: 14
          path: |
            Project-root/coverage.xml
            Project-root/htmlcov

      - name: Coverage threshold check
        working-directory: Project-root
        env:
          MIN_COVERAGE: 25
        run: |
          python - <<'EOF'
          import sys
          import os
          import xml.etree.ElementTree as ET
          
          threshold = float(os.getenv('MIN_COVERAGE', '25'))
          
          try:
              tree = ET.parse('coverage.xml')
              root = tree.getroot()
              coverage_rate = float(root.attrib.get('line-rate', '0')) * 100.0
              
              print(f"Coverage: {coverage_rate:.2f}% (Threshold: {threshold:.2f}%)")
              
              if coverage_rate < threshold:
                  print(f"::warning::Coverage {coverage_rate:.2f}% is below threshold {threshold:.2f}%")
              else:
                  print(f"✅ Coverage meets threshold!")
                  
          except Exception as e:
              print(f"::warning::Coverage check failed: {e}")
          EOF
      
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: Project-root/coverage.xml
          flags: legacy
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
        continue-on-error: true
